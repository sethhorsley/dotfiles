#!/usr/bin/env bash

set -euo pipefail

usage() {
  echo "Usage: gclo <github repo url> [cd]" >&2
  exit 1
}

if [[ ${#@} -lt 1 ]]; then
  usage
fi

do_cd=0
if [[ "${@: -1}" == "cd" ]]; then
  do_cd=1
  set -- "${@:1:$(($#-1))}"
fi

if [[ ${#@} -lt 1 ]]; then
  usage
fi

repo_input="$1"
normalized="$repo_input"

normalized="${normalized%.git}"
normalized="${normalized#git@github.com:}"
normalized="${normalized#https://github.com/}"
normalized="${normalized#http://github.com/}"

if [[ "$normalized" != */* ]]; then
  echo "Unrecognized repo input: $repo_input" >&2
  exit 1
fi

owner="${normalized%%/*}"
repo_name="${normalized##*/}"
repo_https="https://github.com/$owner/$repo_name"

source_dir="$(chezmoi source-path)"
if [[ -d "$source_dir/home" ]]; then
  chezmoi_base="$source_dir/home"
else
  chezmoi_base="$source_dir"
fi
repos_file="$chezmoi_base/.chezmoidata/repos.yaml"

if [[ ! -f "$repos_file" ]]; then
  echo "Missing repos file: $repos_file" >&2
  exit 1
fi

# Parse existing repos from YAML
repos=()
while IFS= read -r line; do
  if [[ "$line" =~ \"([^\"]+)\" ]]; then
    repos+=("${BASH_REMATCH[1]}")
  fi
done < "$repos_file"

# Add new repo if not already present
found=0
for r in "${repos[@]}"; do
  if [[ "$r" == "$repo_https" ]]; then
    found=1
    break
  fi
done

if [[ $found -eq 0 ]]; then
  repos+=("$repo_https")
fi

# Write back to YAML
{
  echo "repos: ["
  for i in "${!repos[@]}"; do
    if [[ $i -lt $((${#repos[@]} - 1)) ]]; then
      echo "  \"${repos[$i]}\","
    else
      echo "  \"${repos[$i]}\""
    fi
  done
  echo "]"
} > "$repos_file"

base_dir="$HOME/files"
target_dir="$base_dir/$owner/$repo_name"

if [[ ! -d "$target_dir/.git" ]]; then
  mkdir -p "$(dirname "$target_dir")"
  git clone "git@github.com:$owner/$repo_name.git" "$target_dir"
fi

if [[ $do_cd -eq 1 ]]; then
  echo "cd \"$target_dir\""
else
  echo "$target_dir"
fi
