#!/bin/bash

{{- if and .op_install_ssh_keys .op_service_account_token }}

# Setup 1Password Service Account Token Environment Variable
set -e

echo "Setting up 1Password service account token..."

# Determine which shell profile to use
SHELL_PROFILE=""
if [ -f ~/.zshrc ]; then
    SHELL_PROFILE=~/.zshrc
elif [ -f ~/.bashrc ]; then
    SHELL_PROFILE=~/.bashrc
elif [ -f ~/.profile ]; then
    SHELL_PROFILE=~/.profile
else
    echo "Warning: Could not find shell profile file (.zshrc, .bashrc, or .profile)"
    echo "You may need to manually set OP_SERVICE_ACCOUNT_TOKEN in your shell."
    exit 0
fi

# Check if the token is already set in the profile
if grep -q "OP_SERVICE_ACCOUNT_TOKEN" "$SHELL_PROFILE"; then
    echo "✓ OP_SERVICE_ACCOUNT_TOKEN already configured in $SHELL_PROFILE"
else
    echo "" >> "$SHELL_PROFILE"
    echo "# 1Password Service Account Token" >> "$SHELL_PROFILE"
    echo "export OP_SERVICE_ACCOUNT_TOKEN='{{ .op_service_account_token }}'" >> "$SHELL_PROFILE"
    echo "✓ Added OP_SERVICE_ACCOUNT_TOKEN to $SHELL_PROFILE"
fi

# Export for current session
export OP_SERVICE_ACCOUNT_TOKEN='{{ .op_service_account_token }}'

echo "✓ 1Password service account configured"

{{- else }}

# No service account token configured
{{- if .op_install_ssh_keys }}
echo "No 1Password service account token configured."
echo "You'll need to authenticate manually with: eval \$(op signin)"
{{- end }}

{{- end }}
