#!/bin/bash

{{- if .op_ssh_enabled }}

# 1Password SSH Agent Setup Script (Linux)
# This script validates the 1Password SSH agent socket configuration

set -e

OP_SSH_SOCKET="{{ .op_ssh_socket }}"

echo "Setting up 1Password SSH agent..."

# Expand tilde in socket path
OP_SSH_SOCKET_EXPANDED="${OP_SSH_SOCKET/#\~/$HOME}"

# Check if 1Password is installed
if ! command -v op &> /dev/null; then
    echo "Warning: 1Password CLI (op) is not installed."
    echo ""
    echo "To install 1Password CLI on Ubuntu/Debian:"
    echo "  curl -sS https://downloads.1password.com/linux/keys/1password.asc | \\"
    echo "    sudo gpg --dearmor --output /usr/share/keyrings/1password-archive-keyring.gpg"
    echo "  echo \"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/1password-archive-keyring.gpg] https://downloads.1password.com/linux/debian/$(dpkg --print-architecture) stable main\" | \\"
    echo "    sudo tee /etc/apt/sources.list.d/1password.list"
    echo "  sudo mkdir -p /etc/debsig/policies/AC2D62742012EA22/"
    echo "  curl -sS https://downloads.1password.com/linux/debian/debsig/1password.pol | \\"
    echo "    sudo tee /etc/debsig/policies/AC2D62742012EA22/1password.pol"
    echo "  sudo mkdir -p /usr/share/debsig/keyrings/AC2D62742012EA22"
    echo "  curl -sS https://downloads.1password.com/linux/keys/1password.asc | \\"
    echo "    sudo gpg --dearmor --output /usr/share/debsig/keyrings/AC2D62742012EA22/debsig.gpg"
    echo "  sudo apt update && sudo apt install 1password-cli"
    echo ""
    echo "Continuing anyway - socket path will be configured..."
fi

# Check if the socket file exists
if [ ! -S "$OP_SSH_SOCKET_EXPANDED" ]; then
    echo ""
    echo "======================================================================"
    echo "WARNING: 1Password SSH agent socket not found at:"
    echo "  $OP_SSH_SOCKET_EXPANDED"
    echo ""
    echo "To enable 1Password SSH agent on Linux:"
    echo ""
    echo "1. Install 1Password desktop app (required for SSH agent):"
    echo "   Download from: https://1password.com/downloads/linux/"
    echo ""
    echo "2. Configure SSH agent:"
    echo "   - Open 1Password app"
    echo "   - Go to Settings → Developer"
    echo "   - Enable 'Use the SSH agent'"
    echo "   - The socket path will be shown there"
    echo ""
    echo "3. Sign in to 1Password and unlock the app"
    echo ""
    echo "Common socket paths on Linux:"
    echo "  - ~/.1password/agent.sock"
    echo "  - \$XDG_RUNTIME_DIR/1password/agent.sock (if using systemd)"
    echo ""
    echo "To find your actual socket path, run:"
    echo "  find ~ -name 'agent.sock' -type s 2>/dev/null | grep 1password"
    echo ""
    echo "If the path is different, run: chezmoi init --force"
    echo "======================================================================"
    echo ""

    # Don't fail - allow setup to continue
    exit 0
fi

echo "✓ 1Password SSH agent socket found at: $OP_SSH_SOCKET_EXPANDED"
echo "✓ SSH config will use 1Password for authentication"

{{- else }}

echo "1Password SSH agent is disabled. Skipping setup."

{{- end }}
