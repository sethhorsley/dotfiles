#!/bin/bash

# 1Password Desktop App Integration Setup (macOS)
# This script helps set up 1Password CLI integration with the desktop app

echo "Checking 1Password desktop app integration..."

# Check if op CLI is installed
if ! command -v op &> /dev/null; then
    echo "⚠ 1Password CLI (op) is not installed yet."
    echo "It will be installed by brew bundle."
    exit 0
fi

# Check if 1Password desktop app is installed
if [ ! -d "/Applications/1Password.app" ]; then
    echo ""
    echo "======================================================================"
    echo "1Password desktop app is not installed"
    echo ""
    echo "To use 1Password CLI with desktop app integration:"
    echo "  1. Install from: https://1password.com/downloads/mac/"
    echo "  2. Or install via brew: brew install --cask 1password"
    echo ""
    echo "After installation, sign in to your account in the app."
    echo "======================================================================"
    exit 0
fi

# Check if CLI integration is enabled by testing authentication
if op whoami &> /dev/null; then
    echo "✓ 1Password CLI is authenticated and working"
    exit 0
fi

# CLI integration might not be enabled
echo ""
echo "======================================================================"
echo "1Password desktop app is installed but CLI integration may not be enabled"
echo ""
echo "To enable CLI integration:"
echo "  1. Open 1Password desktop app"
echo "  2. Go to Settings (⌘,) → Developer"
echo "  3. Enable 'Connect with 1Password CLI'"
echo ""
echo "Once enabled, the CLI will automatically authenticate using the app."
echo "No need to run 'op signin' manually!"
echo ""
echo "After enabling, run: chezmoi apply"
echo "======================================================================"
