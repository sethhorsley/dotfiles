#!/bin/bash

{{- if .op_ssh_enabled }}

# 1Password SSH Agent Setup Script
# This script validates the 1Password SSH agent socket configuration

set -e

OP_SSH_SOCKET="{{ .op_ssh_socket }}"

echo "Setting up 1Password SSH agent..."

# Expand tilde in socket path
OP_SSH_SOCKET_EXPANDED="${OP_SSH_SOCKET/#\~/$HOME}"

# Check if 1Password is installed
if ! command -v op &> /dev/null; then
    echo "Warning: 1Password CLI (op) is not installed."
    echo "Install it with: brew install --cask 1password-cli"
    echo "Continuing anyway - socket path will be configured..."
fi

# Check if the socket file exists
if [ ! -S "$OP_SSH_SOCKET_EXPANDED" ]; then
    echo ""
    echo "======================================================================"
    echo "WARNING: 1Password SSH agent socket not found at:"
    echo "  $OP_SSH_SOCKET_EXPANDED"
    echo ""
    echo "To enable 1Password SSH agent:"
    echo "  1. Open 1Password app"
    echo "  2. Go to Settings → Developer"
    echo "  3. Enable 'Use the SSH agent'"
    echo "  4. The socket path will be shown there"
    echo ""
    echo "Common socket paths:"
    echo "  macOS: ~/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"
    echo ""
    echo "If the path is different, run: chezmoi init --force"
    echo "======================================================================"
    echo ""

    # Don't fail - allow setup to continue
    exit 0
fi

echo "✓ 1Password SSH agent socket found at: $OP_SSH_SOCKET_EXPANDED"
echo "✓ SSH config will use 1Password for authentication"

{{- else }}

echo "1Password SSH agent is disabled. Skipping setup."

{{- end }}
